<html>
  </head>
    <!-- add css link-->
    <script>
      function addClosestToBasket(el){
        var parent = el.parentNode
        var amount = parseInt(parent.querySelector('.card_amount').value)
        var id = parent.querySelector('.card_id').value
        addToBasket(id, amount)
      }

      function readBasket() {
        return JSON.parse(localStorage.getItem('basket')||'{}')
      }

      function addToBasket(id, amount) {
        var basket = readBasket()
        basket[id] = amount + (basket[id]||0)
        localStorage.setItem('basket', JSON.stringify(basket))
      }

      // make sure we can listen to storage chnanges on the same page
      // https://stackoverflow.com/a/43634169/430721
      var originalSetItem = localStorage.setItem;
      localStorage.setItem = function(key, value) {
        var event = new Event('itemInserted');

        event.value = value; // Optional..
        event.key = key; // Optional..

        document.dispatchEvent(event);

        originalSetItem.apply(this, arguments);
      };

      function updateBasket(value){
        const basket = value||readBasket()
        var num = 0;
        for (let key in basket) {
          num += parseInt(basket[key])
        }
        if( num == 0){
          window.basket_num.textContent = "(leeg)"
        } else if( num == 1) {
          window.basket_num.textContent = `${num} item`
        } else {
          window,basket_num.textContent = `${num} items`
        }
      }

      var localStorageSetHandler = function(e) {
        if(e.key === "basket") {
          updateBasket(JSON.parse(e.value))
       }
      };
      document.addEventListener("itemInserted", localStorageSetHandler, false);

    </script>
  </head>
  <body>
    <nav>
      <ul>
        <li class="active"><a href="index.html">Artikelen</a></li>
        <li><a href="basket.html">Winkelwagen</a></li>
        <li><a href="order.html">Kassa</a></li>
      </ul>
      <a href="/basket.html" class="basket">
        <div>Winkelwagen</div>
        <div class="basket_num"></div>
      </a>
    </nav>
    <main id="index">
      <h1>Artikelen</h1>
      <p>Hier zie je een lijst met artikelen die je bij mij kunt bestellen.</p>
      <p>klik op een artikel voor meer informatie<p>
      <p>klik op de "plus" om het artikel in je winkelwagen te stoppen</p>
    </main>
    <footer>
      <hr>
      <p>Deze website is gemaakt door <naam leerling> voor het vak informatica op het Emmauscollege Rotterdam. Laatste bijgewerkt 1 oktober 2020.</p>
    </footer>
    <!-- template for product info-->
    <template id="productcard">
      <div class="card">
        <h1 class="card_title"></h1>
        <p class="card_description"></p>
        <img class="card_image">
        <div class="card_price">â‚¬</div>
        <div class="card_code"></div>
        <input class="card_amount" type="number" value="1">
        <input class="card_id" type="hidden" name="id">
        <button onClick="addClosestToBasket(this)">+</button>
      </div>
    </template> 
    <script>
      (function() {
        // your page initialization code here
        // the DOM will be available here

        const template = document.querySelector('#productcard');

        const app = document.getElementById('index')
        window.basket_num = document.querySelector('.basket_num')
        updateBasket()

        const container = document.createElement('div')
        container.setAttribute('class', 'container')

        app.appendChild(container)

        var request = new XMLHttpRequest()
        request.open('GET', '/api/products', true)
        request.onload = function () {
            var data = JSON.parse(this.response)
            if (request.status >= 200 && request.status < 400) {
              data.forEach((product) => {

                const clone = template.content.cloneNode(true);
                clone.querySelector(".card_title").textContent = product.name
                clone.querySelector(".card_description").textContent =`${product.description}...`
                clone.querySelector(".card_price").textContent += product.price
                clone.querySelector(".card_code").textContent = product.code
                clone.querySelector(".card_id").value = product.id
                clone.querySelector(".card_image").src =`/images/${product.id}.jpg`

                container.appendChild(clone)

                })
            } else {
              const errorMessage = document.createElement('marquee')
              errorMessage.textContent = `Gah, it's not working!`
              app.appendChild(errorMessage)
            }
          }
        request.send()



      })();
    </script>
  </body>
</html>
